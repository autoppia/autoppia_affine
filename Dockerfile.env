FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git curl \
        libglib2.0-0 \
        libnss3 \
        libnspr4 \
        libdbus-1-3 \
        libatk1.0-0 \
        libatk-bridge2.0-0 \
        libatspi2.0-0 \
        libcups2 \
        libdrm2 \
        libx11-6 \
        libxcomposite1 \
        libxdamage1 \
        libxext6 \
        libxfixes3 \
        libxrandr2 \
        libgbm1 \
        libxcb1 \
        libxkbcommon0 \
        libpango-1.0-0 \
        libcairo2 \
        libasound2 && \
    rm -rf /var/lib/apt/lists/*

COPY autoppia_affine/env.py /app/env.py
COPY autoppia_affine/data/autoppia_books_tasks.json /app/data/autoppia_books_tasks.json

RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir "autoppia_iwa @ git+https://github.com/autoppia/autoppia_iwa.git@main" fastapi uvicorn httpx loguru && \
    playwright install chromium

ENV PYTHONPATH=/app \
    DEMO_WEBS_ENDPOINT="http://84.247.180.192" \
    DEMO_WEBS_STARTING_PORT=8000 \
    DEMO_WEB_SERVICE_PORT=8090 \
    VALIDATOR_ID="1" \
    EVALUATOR_HEADLESS=true

WORKDIR /app

EXPOSE 8000

CMD ["uvicorn", "env:app", "--host", "0.0.0.0", "--port", "8000"]
